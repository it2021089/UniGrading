{% extends 'base.html' %}
{% load static %}
{% load view_breadcrumbs %}

{% block title %}Subject Detail{% endblock %}

{% block content %}
<div class="container mt-5">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-light px-3 py-2 rounded shadow-sm">
      {% for name, url in breadcrumbs %}
        <li class="breadcrumb-item"><a href="{{ url }}">{{ name }}</a></li>
      {% endfor %}
    </ol>
  </nav>

  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-sm no-hover-card">
        <!-- Header -->
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <div class="w-100">
            <input
              type="text"
              id="subject-name"
              class="form-control-plaintext text-white h4 w-100"
              readonly
              value="{{ subject.name }}"
            >
            <div class="small text-white-50">
              Taught by:
              {% if subject.professor.first_name or subject.professor.last_name %}
                {{ subject.professor.first_name }} {{ subject.professor.last_name }}
              {% else %}
                {{ subject.professor.email }}
              {% endif %}
            </div>
          </div>

          {# Owner can edit title; students see read-only #}
          {% if request.user.role == 'professor' and request.user.id == subject.professor_id %}
          <div class="btn-group ml-3">
            <button class="btn btn-sm btn-light mr-1" id="btn-edit-title" onclick="editSubjectName()">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-success d-none" id="save-subject-name" onclick="saveSubjectName()">
              <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-sm btn-outline-light d-none" id="cancel-subject-name" onclick="cancelSubjectNameEdit()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          {% endif %}
        </div>

        <div class="card-body">
          <!-- Description -->
          <div class="mb-4">
            <label class="form-label font-weight-bold">Description</label>
            <textarea id="subject-description" class="form-control" rows="3" readonly>{{ subject.description }}</textarea>

            {% if request.user.role == 'professor' and request.user.id == subject.professor_id %}
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-primary mr-1" onclick="editDescription()">Edit</button>
              <button class="btn btn-success btn-sm d-none" id="save-description" onclick="saveDescription()">Save</button>
              <button class="btn btn-danger btn-sm d-none" id="cancel-description" onclick="cancelEdit()">Cancel</button>
            </div>
            {% endif %}
          </div>
          {% if can_unenroll %}
          <form method="post" action="{% url 'subjects:unenroll_subject' subject.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
              <i class="fas fa-sign-out-alt"></i> Unenroll
            </button>
          </form>
          <hr>
        {% endif %}
          <!-- Categories -->
          <h5 class="font-weight-bold mb-3">Categories</h5>
          <ul class="list-group mb-4" id="categories-list">
            {% for category in categories %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center w-100">
                  <i class="fas fa-folder text-warning mr-2"></i>

                  <!-- Clicking when readonly navigates -->
                  <input
                    id="category-name-{{ category.id }}"
                    type="text"
                    class="form-control-plaintext flex-grow-1 text-primary"
                    value="{{ category.name }}"
                    readonly
                    style="cursor:pointer"
                    onclick="navigateIfReadonly({{ category.id }}, '{{ category.name }}')"
                  />

                  {% if category.name in protected_categories %}
                    <span class="badge badge-secondary ml-2">Default</span>
                  {% endif %}
                </div>

                {% if request.user.role == 'professor' and request.user.id == subject.professor_id %}
                  {% if category.name not in protected_categories %}
                  <div class="btn-group ml-2">
                    <button class="btn btn-sm btn-outline-primary mr-1" onclick="editCategoryName({{ category.id }})">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-success btn-sm d-none" id="save-category-{{ category.id }}" onclick="saveCategoryName({{ category.id }})">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteCategory({{ category.id }})">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm d-none" id="cancel-category-{{ category.id }}" onclick="cancelCategoryEdit({{ category.id }}, '{{ category.name }}')">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  {% endif %}
                {% endif %}
              </li>
            {% empty %}
              <li class="list-group-item text-muted">No categories available.</li>
            {% endfor %}
          </ul>

          <!-- Add category (professor/owner only) -->
          {% if request.user.role == 'professor' and request.user.id == subject.professor_id %}
          <div class="input-group">
            <input type="text" id="new-category-name" class="form-control" placeholder="New Category Name">
            <div class="input-group-append">
              <button class="btn btn-outline-primary" onclick="addCategory()">
                <i class="fas fa-plus"></i> Add Category
              </button>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document"><div class="modal-content">
    <div class="modal-header bg-warning">
      <h5 class="modal-title">Are you sure?</h5>
      <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
    </div>
    <div class="modal-body" id="confirmModalBody">Are you sure you want to continue?</div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      <button class="btn btn-danger" id="confirmModalYesBtn">Yes</button>
    </div>
  </div></div>
</div>

<div class="modal fade" id="infoModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document"><div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">Notice</h5>
      <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
    </div>
    <div class="modal-body" id="infoModalBody">Message goes here.</div>
    <div class="modal-footer">
      <button class="btn btn-info" data-dismiss="modal">OK</button>
    </div>
  </div></div>
</div>

<script>
  function csrf() { return '{{ csrf_token }}'; }

  function showInfo(msg) {
    document.getElementById("infoModalBody").innerText = msg;
    $('#infoModal').modal('show');
  }

  function showConfirm(message, onYes) {
    document.getElementById("confirmModalBody").innerText = message;
    const yesBtn = document.getElementById("confirmModalYesBtn");
    const newBtn = yesBtn.cloneNode(true);
    yesBtn.parentNode.replaceChild(newBtn, yesBtn);
    newBtn.addEventListener("click", function () {
      $('#confirmModal').modal('hide');
      onYes();
    });
    $('#confirmModal').modal('show');
  }

  /* ===== Subject title editing (owner only; buttons hidden for students) ===== */
  function editSubjectName() {
    const input = document.getElementById("subject-name");
    input.readOnly = false;
    input.classList.remove("form-control-plaintext", "text-white");
    input.classList.add("form-control", "bg-white", "text-dark");
    document.getElementById("save-subject-name").classList.remove("d-none");
    document.getElementById("cancel-subject-name").classList.remove("d-none");
    document.getElementById("btn-edit-title").classList.add("d-none");
    input.focus();
  }

  function saveSubjectName() {
    const input = document.getElementById("subject-name");
    const newName = input.value.trim();
    if (!newName) return showInfo("Subject name cannot be empty.");

    fetch(window.location.href, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": csrf() },
      body: `update_subject_name=1&subject_name=${encodeURIComponent(newName)}`
    })
    .then(r => r.json())
    .then(d => {
      if (d.status === "success") {
        location.reload();
      } else {
        showInfo(d.message || "Update failed.");
      }
    })
    .catch(() => showInfo("Update failed."));
  }

  function cancelSubjectNameEdit() {
    const input = document.getElementById("subject-name");
    input.value = "{{ subject.name }}";
    input.readOnly = true;
    input.classList.add("form-control-plaintext", "text-white");
    input.classList.remove("form-control", "bg-white", "text-dark");
    const saveBtn = document.getElementById("save-subject-name");
    const cancelBtn = document.getElementById("cancel-subject-name");
    const editBtn = document.getElementById("btn-edit-title");
    if (saveBtn) saveBtn.classList.add("d-none");
    if (cancelBtn) cancelBtn.classList.add("d-none");
    if (editBtn) editBtn.classList.remove("d-none");
  }

  /* ===== Description editing (owner only; buttons hidden for students) ===== */
  function editDescription() {
    const input = document.getElementById("subject-description");
    input.readOnly = false;
    input.focus();
    document.getElementById("save-description").classList.remove("d-none");
    document.getElementById("cancel-description").classList.remove("d-none");
  }

  function saveDescription() {
    const input = document.getElementById("subject-description");
    fetch(window.location.href, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": csrf() },
      body: `description=${encodeURIComponent(input.value)}`
    }).then(r => r.json()).then(d => {
      if (d.status === "success") location.reload();
      else showInfo("Failed to save.");
    });
  }

  function cancelEdit() {
    document.getElementById("subject-description").value = "{{ subject.description }}";
    document.getElementById("subject-description").readOnly = true;
    const saveBtn = document.getElementById("save-description");
    const cancelBtn = document.getElementById("cancel-description");
    if (saveBtn) saveBtn.classList.add("d-none");
    if (cancelBtn) cancelBtn.classList.add("d-none");
  }

  /* ===== Category actions ===== */
  function navigateIfReadonly(id, name) {
    const input = document.getElementById(`category-name-${id}`);
    if (!input || input.readOnly === false) return;

    if (name === "Assignments") {
      window.location.href = "/assignments/{{ subject.id }}/";
    } else if (name === "Tests") {
      window.location.href = "{% url 'tests:my_tests' subject.id %}";
    } else {
      window.location.href = "{% url 'subjects:category_detail' 0 %}".replace("0", id);
    }
  }

  function confirmDeleteCategory(id) {
    showConfirm("Delete this category?", () => {
      fetch(window.location.href, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": csrf() },
        body: `delete_category=1&category_id=${id}`
      }).then(() => location.reload());
    });
  }

  function addCategory() {
    const name = document.getElementById("new-category-name").value.trim();
    if (!name) return showInfo("Category name cannot be empty.");
    fetch(window.location.href, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": csrf() },
      body: `new_category=${encodeURIComponent(name)}`
    })
    .then(r => r.json())
    .then(d => {
      if (d.status === "success") {
        location.reload();
      } else if (d.status === "error") {
        showInfo(d.message || "Could not add category.");
      }
    });
  }

  function editCategoryName(id) {
    const input = document.getElementById(`category-name-${id}`);
    if (!input) return;
    input.readOnly = false;
    input.classList.remove("form-control-plaintext");
    input.classList.add("form-control", "bg-white");
    input.focus();
    const saveBtn = document.getElementById(`save-category-${id}`);
    const cancelBtn = document.getElementById(`cancel-category-${id}`);
    if (saveBtn) saveBtn.classList.remove("d-none");
    if (cancelBtn) cancelBtn.classList.remove("d-none");
  }

  function cancelCategoryEdit(id, originalName) {
    const input = document.getElementById(`category-name-${id}`);
    if (!input) return;
    input.value = originalName;
    input.readOnly = true;
    input.classList.add("form-control-plaintext");
    input.classList.remove("form-control", "bg-white");
    const saveBtn = document.getElementById(`save-category-${id}`);
    const cancelBtn = document.getElementById(`cancel-category-${id}`);
    if (saveBtn) saveBtn.classList.add("d-none");
    if (cancelBtn) cancelBtn.classList.add("d-none");
  }

  function saveCategoryName(id) {
    const input = document.getElementById(`category-name-${id}`);
    if (!input) return;
    const name = input.value.trim();
    if (!name) return showInfo("Name cannot be empty.");

    fetch(window.location.href, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": csrf() },
      body: `update_category=1&category_id=${id}&category_name=${encodeURIComponent(name)}`
    })
    .then(r => r.json())
    .then(d => {
      if (d.status === "error" && d.message && d.message.includes("already exists")) {
        showInfo(d.message);
      } else {
        location.reload();
      }
    });
  }
</script>
{% endblock %}
