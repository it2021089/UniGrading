{% extends 'base.html' %}
{% load humanize %}
{% block title %}Submission – {{ submission.student.get_full_name|default:submission.student.email }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      {% for name, url in breadcrumbs %}
        <li class="breadcrumb-item"><a href="{{ url }}">{{ name }}</a></li>
      {% endfor %}
      <li class="breadcrumb-item"><a href="{% url 'assignments:assignment_submissions' submission.assignment.pk %}">Submissions</a></li>
      <li class="breadcrumb-item active" aria-current="page">Submission Detail</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>
      {{ submission.student.get_full_name|default:submission.student.email }}
      <small class="text-muted d-block">for “{{ submission.assignment.title }}”</small>
    </h3>
    <a href="{% url 'assignments:assignment_submissions' submission.assignment.pk %}" class="btn btn-outline-secondary">
      ← Back to Submissions
    </a>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="card no-hover-card mb-4">
    <div class="card-body">
      <p class="mb-1">
        <strong>Submitted:</strong>
        {{ submission.submitted_at|date:"M d, Y H:i" }} ({{ submission.submitted_at|naturaltime }})
      </p>
      <p class="mb-1">
        <strong>Status:</strong>
        <span class="badge badge-info">{{ submission.autograde_status|default:"n/a" }}</span>
      </p>
      <p class="mb-1">
        <strong>Grade:</strong>
        {% if submission.grade_pct is not None %}
          <span class="badge badge-success">{{ submission.grade_pct|floatformat:2 }}%</span>
        {% else %}
          <span class="text-muted">Pending</span>
        {% endif %}
      </p>
      <p class="mb-0">
        <strong>File:</strong>
        <span class="text-muted">{{ file_basename }}</span>
      </p>

      <div class="mt-3 btn-group">
        <a class="btn btn-sm btn-outline-info"
           href="{% url 'assignments:preview_submission_file' submission.pk %}" target="_blank" rel="noopener">
          Preview
        </a>
        <a class="btn btn-sm btn-outline-success"
           href="{% url 'assignments:download_submission_file' submission.pk %}">
          Download
        </a>
      </div>
    </div>
  </div>

  <div class="card no-hover-card mb-4">
    <div class="card-header bg-light"><strong>Comments</strong></div>
    <div class="card-body">
      {% if submission.ai_feedback %}
        <pre class="mb-0" style="white-space:pre-wrap;">{{ submission.ai_feedback }}</pre>
      {% else %}
        <span class="text-muted">No comments yet.</span>
      {% endif %}
    </div>
  </div>

  {% if submission.runner_logs %}
    <div class="card no-hover-card mb-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <strong>Runner Logs</strong>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#logs">
          Toggle
        </button>
      </div>
      <div id="logs" class="collapse show">
        <div class="card-body">
          <pre class="mb-0" style="white-space:pre-wrap; max-height: 420px; overflow:auto;">{{ submission.runner_logs }}</pre>
        </div>
      </div>
    </div>
  {% endif %}

  {# ---- Owner-only: edit grade & comment ---- #}
  {% if user == submission.assignment.professor %}
    <div class="card no-hover-card mb-5">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <strong>Edit Grade &amp; Comment</strong>
        <small class="text-white-50">Professor override</small>
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'assignments:update_submission_grade' submission.pk %}">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group col-md-3">
              <label for="grade_pct">Grade (0–100)</label>
              <input
                type="number"
                step="0.01"
                min="0"
                max="100"
                class="form-control"
                id="grade_pct"
                name="grade_pct"
                value="{% if submission.grade_pct is not None %}{{ submission.grade_pct|floatformat:2 }}{% endif %}"
                placeholder="e.g. 87.5"
              >
              <small class="form-text text-muted">
                Leave blank to clear grade (sets it to pending).
              </small>
            </div>
            <div class="form-group col-md-9">
              <label for="ai_feedback">Comment</label>
              <textarea
                id="ai_feedback"
                name="ai_feedback"
                rows="5"
                class="form-control"
                placeholder="Write feedback to the student…"
              >{% if submission.ai_feedback %}{{ submission.ai_feedback }}{% endif %}</textarea>
              <small class="form-text text-muted">
                This replaces the current comment shown to the student.
              </small>
            </div>
          </div>

          <div class="d-flex">
            <button type="submit" class="btn btn-primary mr-2">
              <i class="fas fa-save"></i> Save
            </button>
            <a href="{% url 'assignments:assignment_submissions' submission.assignment.pk %}" class="btn btn-secondary">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
